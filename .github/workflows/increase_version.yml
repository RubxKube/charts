---
name: Update chart version
permissions: write-all
on:

  pull_request:
jobs:
  increase-version:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.17.0'

      - name: Get changed files in the charts folder
        id: changed-files-specific
        uses: tj-actions/changed-files@v46.0.4
        with:
          files: charts/**

      - name: Run update for any chart concerned by the commit
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: |
          echo "---------------------------------------"
          echo "Input: ${{ steps.changed-files-specific.outputs.all_changed_files }}"
          echo "Extract chart names"
          edited_charts_list=()
          for chart in ${{ steps.changed-files-specific.outputs.all_changed_files }}; do
            echo "Processing $chart"
            chart_name=$(echo "$chart" | cut -d"/" -f2 )
            edited_charts_list+=("$chart_name")
          done
          echo "Remove duplicates..."
          chart_list=($(printf "%s\n" "${edited_charts_list[@]}" | sort -u))
          echo "New list: ${chart_list[@]}"
          echo "---------------------------------------"

          for chart in "${chart_list[@]}"; do
            if [[ -d "charts/$chart" ]]; then
              echo "Updating chart version for $chart"
              cd "charts/$chart"
              cat Chart.yaml | yq '.version |= (split(".") | .[-1] |= ((. tag = "!!int") + 1) | join("."))' > /tmp/Chart.yaml
              mv /tmp/Chart.yaml Chart.yaml
              cd -
            fi
          done
  #  yq -i '.version |= (split(".") | .[-1] |= ((. tag = "!!int") + 1) | join("."))' Chart.yaml

      - name: Show changes
        run: |
          git diff
